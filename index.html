<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clerk Test</title>
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_live_Y2xlcmsuYXV0aC10ZXN0Lm5vcmRvci5jbyQ"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>
</head>
<body>
  <h1>Clerk Demo</h1>
  <div id="sign-in"></div>
  <button id="fetchMessage" style="display:none;">Get Welcome Message</button>
  <p id="message"></p>

  <script>
    async function waitForClerk(timeout = 5000) {
      const start = Date.now();
      while (!window.Clerk) {
        if (Date.now() - start > timeout) {
          throw new Error("Clerk script failed to load");
        }
        await new Promise(r => setTimeout(r, 50));
      }
      return window.Clerk;
    }
    // This function will be called once Clerk is loaded
    async function initializeClerk() {
      try {
        // Wait for Clerk to be available
        const clerk = await waitForClerk();

        // Initialize Clerk
        await clerk.load({ publishableKey: "pk_live_Y2xlcmsuYXV0aC10ZXN0Lm5vcmRvci5jbyQ" });

        if (clerk.user) {
          // User is signed in
          document.getElementById("sign-in").innerHTML = `
            <p>Signed in as <b>${clerk.user.username || clerk.user.id}</b></p>
            <button id="sign-out">Sign Out</button>
          `;
          document.getElementById("fetchMessage").style.display = "block";
          
          // Add sign out handler
          document.getElementById("sign-out").addEventListener("click", () => {
            clerk.signOut();
            window.location.reload();
          });
        } else {
          // User is not signed in
          clerk.mountSignIn(document.getElementById("sign-in"));
        }

        // Fetch welcome message
        document.getElementById("fetchMessage")?.addEventListener("click", async () => {
          try {
            const token = await clerk.session?.getToken();
            if (!token) {
              document.getElementById("message").innerText = "No auth token available. Are you signed in?";
              return;
            }

            const res = await fetch("/api/welcome", {
              credentials: "same-origin",
              headers: {
                "Accept": "application/json"
              }
            });

            const ct = res.headers.get("content-type") || "";
            if (!res.ok) {
              const body = ct.includes("application/json") ? await res.json().catch(() => ({})) : await res.text().catch(() => "");
              console.error("/api/welcome error", { status: res.status, ct, bodySample: typeof body === 'string' ? body.slice(0, 200) : body });
              document.getElementById("message").innerText = `Error: ${res.status} fetching message`;
              return;
            }

            if (ct.includes("application/json")) {
              const data = await res.json();
              document.getElementById("message").innerText = data.message;
            } else {
              const text = await res.text();
              console.error("/api/welcome returned non-JSON", { ct, sample: text.slice(0, 200) });
              document.getElementById("message").innerText = "Error: Received non-JSON response from server";
            }
          } catch (error) {
            console.error("Error fetching welcome message:", error);
            document.getElementById("message").innerText = "Error: Could not fetch message";
          }
        });

      } catch (error) {
        console.error("Clerk initialization error:", error);
        document.getElementById("message").innerText = "Error initializing authentication";
      }
    }

    // Wait for the page to load and Clerk to be available
    document.addEventListener("DOMContentLoaded", () => {
      // Check if Clerk is already loaded
      if (window.Clerk) {
        initializeClerk();
      } else {
        // If not, wait for the load event
        window.addEventListener('load', initializeClerk);
      }
    });
  </script>
</body>
</html>
